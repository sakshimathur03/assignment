pipeline {
  agent any

  environment {
    AZURE_CREDENTIALS_ID = 'azure-service-principal'
    ACR_NAME = 'sakshiacr25'
    IMAGE_NAME = 'assignmentTDKJ'
    RESOURCE_GROUP = 'rg-assesment'
    CLUSTER_NAME = 'sakshiaks34'
  }

  stages {
    stage('Terraform Init & Apply') {
      steps {
        dir('Terraform') {
          bat 'terraform init'
          bat 'terraform apply -auto-approve'
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        bat 'az acr login --name $ACR_NAME'
        bat "docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:latest ."
      }
    }

    stage('Push to ACR') {
      steps {
        bat "docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:latest"
      }
    }

    stage('Deploy to AKS') {
      steps {
        bat "az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME --overwrite-existing"
        bat 'kubectl apply -f deployment.yaml'
        bat 'kubectl apply -f service.yaml'
      }
    }
  }
}
